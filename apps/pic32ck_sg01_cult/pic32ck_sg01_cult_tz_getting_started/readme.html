<p><img src = "images/microchip_logo.png">
<img src = "images/microchip_mplab_harmony_logo_small.png"></p>
<h1
id="trustzone-getting-started-on-pic32ck-sg01-curiosity-ultra-development-board">TrustZone
Getting Started on PIC32CK SG01 Curiosity Ultra Development Board</h1>
<h2 align="center">
<a href="https://github.com/Microchip-MPLAB-Harmony/reference_apps/releases/latest/download/pic32ck_sg01_cult_tz_getting_started.zip" >
Download </a>
</h2>
<hr />
<h2 id="description">Description</h2>
<blockquote>
<p>This application demonstrates the TrustZone feature on the PIC32CK
SG01 microcontroller (MCU). The application has two projects pertaining
to Secure and Non-Secure modes of PIC32CK SG01 that work together on the
same MCU and offers security isolation between the trusted and the
non-trusted resources in the device.</p>
</blockquote>
<p>The application includes Basic and Extended functionalities.</p>
<ul>
<li><strong>Basic application:</strong>
<ul>
<li>The Secure mode application toggles an LED (LED0 toggles when the
switch SW0 is pressed) on a timeout basis and the periodicity of the
timeout will change from 500 milliseconds to one second, two seconds,
four seconds, and back to 500 milliseconds every time you press the
switch SW0 on the PIC32CK SG01 Curiosity Ultra Development Board.</li>
<li>The Non-secure application requests the Secure mode application,
reads the LED toggling rate and prints on the serial terminal. The LED
toggling rate data is transferred to the Non-secure mode application
when it requests to Secure application through Non-Secure Callables
(NSC).</li>
</ul></li>
<li><strong>Extended application:</strong>
<ul>
<li><p>The Secure mode application reads the current room temperature
from the temperature sensor on the I/O1 Xplained Pro Extension Kit every
500 milliseconds. Further, the application writes the temperature
readings to EEPROM and reads when a request is received from the
Non-secure mode application. Also, a green LED (LED0) is toggled every
time the temperature display request is received from the Non-secure
mode application. The periodicity of the temperature values reading can
be changed to 1 second, 2 seconds, 4 seconds, and back to 500
milliseconds whenever the user presses the switch SW0 on the PIC32CK
SG01 Curiosity Ultra Development Board. The temperature readings are
transferred to the Non-secure mode application when it requests to
Secure application through Non-Secure Callables (NSC).</p></li>
<li><p>The Non-secure mode application requests the Secure mode
application the temperature values and prints them on a serial console
once it receives from the Secure mode application. Further, when it gets
a request from the user (in the form of a key press on the serial
console), it will request the Secure mode application to retrieve the
last five stored temperature values in the EEPROM. The Non-secure
application prints the last five stored temperature values on the
console. Also, a red LED (LED1) is toggled every time the temperature
values are read from EEPROM.</p></li>
</ul></li>
</ul>
<h2 id="modulestechnology-used">Modules/Technology Used:</h2>
<ul>
<li>Peripheral Modules
<ul>
<li>Secure PORT Pins (All pins by default are secure)</li>
<li>Secure I2C</li>
<li>Secure RTC</li>
<li>Secure EIC</li>
<li>Non-secure USART</li>
<li>Non-secure DMAC</li>
<li>Non-secure PORT Pins (USART Pins only)</li>
</ul></li>
</ul>
<h2 id="hardware-used">Hardware Used:</h2>
<ul>
<li><a
href="https://www.microchip.com/en-us/development-tool/EA14V17A">PIC32CK
SG01 Curiosity Ultra Development Board</a></li>
<li><a
href="https://www.microchip.com/Developmenttools/ProductDetails/ATIO1-XPRO">I/O1
Xplained Pro Extension Kit</a></li>
</ul>
<h2 id="softwaretools-used">Software/Tools Used:</h2>
<p><span style="color:blue"> This project has been verified to work with
the following versions of software tools:</span></p>
<p>Refer Manifest for <a
href="./firmware/Secure/firmware/src/config/pic32ck_sg01_cult/harmony-manifest-success.yml">Secure</a>
and <a
href="./firmware/NonSecure/firmware/src/config/pic32ck_sg01_cult/harmony-manifest-success.yml">NonSecure</a>
projects present in harmony-manifest-success.yml under the project
folder <em>firmware/{Secure or
NonSecure}/firmware/src/config/pic32ck_sg01_cult</em><br />
- Refer the <a
href="../../../release_notes.md#development-tools">Release Notes</a> to
know the <strong>MPLAB X IDE</strong> and <strong>MCC</strong> Plugin
version. Alternatively, <a
href="https://github.com/Microchip-MPLAB-Harmony/reference_apps/blob/master/release_notes.md#development-tools">Click
Here</a>.<br />
- Any Serial Terminal application like Tera Term terminal
application.</p>
<p><span style="color:blue"> Because Microchip regularly update tools,
occasionally issue(s) could be discovered while using the newer versions
of the tools. If the project doesn’t seem to work and version
incompatibility is suspected, It is recommended to double-check and use
the same versions that the project was tested with. </span> To download
original version of MPLAB Harmony v3 packages, refer to document <a
href="https://ww1.microchip.com/downloads/en/DeviceDoc/How-to-Use-the-MPLAB-Harmony-v3-Project-Manifest-Feature-DS90003305.pdf">How
to Use the MPLAB Harmony v3 Project Manifest Feature</a></p>
<p><strong>Note: The Application is built and developed using
PIC32CK-SG_DFP version 1.2.161. Please use PIC32CK-SG_DFP version
1.2.161 or above to build this Application. If you need help regarding
the DFP versions, Kindly contact Microchip Sales.</strong></p>
<h2 id="hardware-setup-1">Hardware Setup 1:
<span id="Setup1"><span></h2>
<ul>
<li>The PIC32CK SG01 Curiosity Ultra Development Board allows the
Embedded Debugger (PKoB4) to be used for debugging.</li>
<li>Connect the Type-A male to Micro-B USB cable to Micro-B DEBUG USB
port (J900) to power and debug the PIC32CK SG01 Curiosity Ultra
Development Board<br />
<img src = "images/hardware_setup.png" align="middle"></li>
<li>The PIC32CK SG01 Curiosity Ultra Development Board allows the
Embedded Debugger (PKoB4) to be used for debugging. Connect the Type-A
male to micro-B USB cable to the micro-B DEBUG USB port to power and
debug the PIC32CK SG01 Curiosity Ultra Development Board.</li>
</ul>
<h2 id="hardware-setup-2">Hardware Setup 2:
<span id="Setup2"><span></h2>
<ul>
<li>The PIC32CK SG01 Curiosity Ultra Development Board allows the
Embedded Debugger (PKoB4) to be used for debugging.</li>
<li>Connect the Type-A male to Micro-B USB cable to Micro-B DEBUG USB
port (J900) to power and debug the PIC32CK SG01 Curiosity Ultra
Development Board<br />
</li>
<li>To test the extended functionality, connect the <a
href="https://www.microchip.com/Developmenttools/ProductDetails/ATIO1-XPRO">I/O1
Xplained Pro Extension Kit</a> to the extension header EXT1 (J500) on
the PIC32CK SG01 Curiosity Ultra Development Board.<br />
<img src = "images/hardware_setup_ext.jpg" align="middle"></li>
</ul>
<h2 id="trustzone-application-development-use-cases">TrustZone
Application Development Use Cases</h2>
<ul>
<li><p>There are two use cases:</p>
<ul>
<li><strong>Single Developer</strong> (This application demonstrates a
single developer use case)</li>
<li><strong>Dual Developer</strong></li>
</ul></li>
<li><p><strong>1. Single Developer</strong></p>
<ul>
<li><p>A single developer develops both Secure and Non-Secure
applications.</p></li>
<li><p>The following steps are automatically taken care of by the
MCC.</p>
<ul>
<li>MCC generates both Secure and Non-Secure projects and sets the
Secure project as a loadable project to the Non-Secure project</li>
</ul>
<p><img src = "images/single_develper_usecase_01.png"></p>
<ul>
<li>Configures the Secure project to generate the veneer library in the
Non-Secure project path
(NonSecure/firmware/tz_pic32ck_sg01_cult_NonSecure.X/tz_pic32ck_sg01_cult_Secure_sg_veneer.lib)</li>
</ul>
<p><img src = "images/single_develper_usecase_02.png"></p>
<ul>
<li>Configures the Non-Secure project to link the veneer library.</li>
</ul>
<p><img src = "images/single_develper_usecase_03.png"></p></li>
</ul></li>
<li><p><strong>2. Dual Developer</strong></p>
<ul>
<li>The dual developer use case involves two developers.</li>
<li>Initially, Developer A is responsible for developing the Secure
application; then, Developer B is responsible for developing the
Non-Secure application.
<ul>
<li>Refer <a href="#Comments">Comments</a> for more details on the
<strong>“Dual Developer Application Development Use Case”</strong></li>
</ul></li>
</ul></li>
</ul>
<h2 id="programming-methods">Programming Methods:</h2>
<ul>
<li>The device can be programmed in two ways
<ul>
<li>Refer <a href="#ProgrammingHex">Method 1</a>: Programming using the
prebuilt hex file.</li>
<li>Refer <a href="#ApplicationProject">Method 2</a>: Programming by
opening and building the application project.</li>
</ul></li>
</ul>
<h2 id="method-1-steps-for-programming-prebuilt-hex-file">Method 1:
Steps for Programming prebuilt hex file:
<span id="ProgrammingHex"><span></h2>
<ul>
<li>The TrustZone project will have Secure and Non-Secure pre-built hex
files</li>
<li>Program Secure hex file first followed by the Non-Secure hex
file</li>
<li>The following are the steps to program these hex files</li>
<li>Download and extract the <a
href="https://github.com/Microchip-MPLAB-Harmony/reference_apps/releases/latest/download/pic32ck_sg01_cult_tz_getting_started.zip">pic32ck_sg01_cult_tz_getting_started</a>
project, if not done already.</li>
<li>Open MPLAB X IDE</li>
<li>Close all existing projects in IDE, if any project is opened</li>
</ul>
<h3 id="step-1-program-the-secure-project-hex-file">Step 1: Program the
Secure Project hex file</h3>
<ul>
<li><p>Go to File -&gt; Import -&gt; Hex/ELF File</p></li>
<li><p>In the <strong>“Import Image File”</strong> window,</p>
<ul>
<li>Step 1 - Create Prebuilt Project,
<ul>
<li>Click the <strong>“Browse”</strong> button to select the prebuilt
<strong>“pic32ck_sg01_cult_Secure.X.production.hex”</strong> file from
project path
<strong>“pic32ck_sg01_cult_tz_getting_started/hex”</strong></li>
<li>Select Device as <strong>“PIC32CK2051SG01144”</strong></li>
<li>Ensure <strong>“PIC32CK SG01 Curiosity Ultra”</strong> is selected
under <strong>“Hardware Tool”</strong> and click <strong>“Next”</strong>
button</li>
</ul></li>
<li>Step 2 - Select Project Name and Folder,
<ul>
<li>Select appropriate project name and folder and click
<strong>“Finish”</strong> button</li>
</ul></li>
</ul></li>
<li><p>Once the project opens, set the
<strong>“pic32ck_sg01_cult_Secure.X.prebuilt”</strong> project as Main
Project by right clicking on the project.</p>
<p><img src = "images/hex_s_prj_set_as_main_project.png"></p></li>
<li><p>Go to project properties and set Program Options under PKoB4
categories to erase and program only Secure memory region.</p>
<p><img src = "images/hex_s_prj_pkob4_config.png"></p></li>
<li><p>In MPLAB X IDE, click on <strong>“Make and Program
Device”</strong> button to program the device.</p></li>
</ul>
<h3 id="step-2-program-the-non-secure-project-hex-file">Step 2: Program
the Non-Secure Project hex file</h3>
<ul>
<li><p>Go to File -&gt; Import -&gt; Hex/ELF File</p></li>
<li><p>In the <strong>“Import Image File”</strong> window,</p>
<ul>
<li>Step 1 - Create Prebuilt Project,
<ul>
<li>Click the <strong>“Browse”</strong> button to select the prebuilt
<strong>“pic32ck_sg01_cult_NonSecure.X.production.hex”</strong> file
from project path
<strong>“pic32ck_sg01_cult_tz_getting_started/hex”</strong></li>
<li>Select Device as <strong>“PIC32CK2051SG01144”</strong></li>
<li>Ensure <strong>“PIC32CK SG01 Curiosity Ultra”</strong> is selected
under <strong>“Hardware Tool”</strong> and click <strong>“Next”</strong>
button</li>
</ul></li>
<li>Step 2 - Select Project Name and Folder,
<ul>
<li>Select appropriate project name and folder and click
<strong>“Finish”</strong> button</li>
</ul></li>
</ul></li>
<li><p>Once the project opens, set the
<strong>“pic32ck_sg01_cult_NonSecure.X.prebuilt”</strong> project as
Main Project by right clicking on the project.</p>
<p><img src = "images/hex_ns_prj_set_as_main_project.png"></p></li>
<li><p>In the <strong>“pic32ck_sg01_cult_NonSecure.X.prebuilt”</strong>
project, right click on Loadables folder and click on <strong>“Add
Loadable File”</strong> to add Secure Gateway veneer library as shown
below.</p>
<p><img src = "images/hex_ns_prj_add_veneer_lib.png"></p></li>
<li><p>Select <strong>“pic32ck_sg01_cult_Secure_sg_veneer.lib”</strong>
veneer library.</p>
<p><img src = "images/hex_ns_prj_load_veneer_lib.png"></p></li>
<li><p>Expand Loadables folder to confirm that the veneer library is
added to the Non-Secure project.</p>
<p><img src = "images/hex_ns_prj_veneer_lib.png"></p></li>
<li><p>Go to project properties and set Program Options under PKoB4
categories to erase and program only Non-Secure memory region.</p>
<p><img src = "images/hex_ns_prj_pkob4_config.png"></p></li>
<li><p>In MPLAB X IDE, click on <strong>“Make and Program
Device”</strong> button to program the device.</p></li>
<li><p>Follow the steps in <strong><a href="#RunningDemo">Running the
Demo</a></strong> section below</p></li>
</ul>
<h2 id="method-2-programmingdebugging-application-project">Method 2:
Programming/Debugging Application Project:
<span id="ApplicationProject"><span></h2>
<ul>
<li>The Trustzone project can be opened in two ways.
<ul>
<li><p>Procedure 1:</p>
<ul>
<li>Open MPLAB X IDE</li>
<li>Close all existing projects in IDE (if any project is opened)</li>
<li>Go to File -&gt; Open Project</li>
<li>Go to <strong>reference_apps</strong> repo path and navigate to
following path
<ul>
<li><code>&lt;reference_apps_path&gt;/apps/pic32ck_sg01_cult/pic32ck_sg01_cult_tz_getting_started</code></li>
</ul></li>
<li>Select “firmware” folder, enable “Open Required Projects” and click
on “Open Project” button</li>
</ul>
<p><img src = "images/group_project_path.png"></p>
<p><img src = "images/opened_group_project.png"></p>
<ul>
<li>Once the project opens, set the “tz_pic32ck_sg01_cult_NonSecure”
project as Main Project by right clicking on the project.</li>
</ul>
<p><img src = "images/set_as_main_project.png"></p></li>
<li><p>Procedure 2:</p>
<ul>
<li><p>Open MPLAB X IDE</p></li>
<li><p>Close all existing projects in IDE (if any project is
opened)</p></li>
<li><p>Open the project
(../pic32ck_sg01_cult_tz_getting_started/firmware/NonSecure/firmware/tz_pic32ck_sg01_cult_NonSecure.X)
in MPLAB X IDE.</p>
<p><img src = "images/opened_non_secure_project.png" ></p></li>
</ul></li>
</ul></li>
<li>Ensure “PIC32CK SG01 Curiosity Ultra” is selected as hardware tool
to program/debug the application.</li>
<li>Build the code and program the device by clicking on the “Make and
Program Device” button in MPLAB X IDE tool bar</li>
<li>Follow the steps in “Running the Demo” section below.<br />
</li>
<li><strong>Note:</strong>
<ul>
<li>Windows OS has a maximum path length of 260 characters and a
command-line limitation for Windows OS of 8191 characters. For details,
see <a
href="https://onlinedocs.microchip.com/oxy/GUID-D79ACEBE-41BD-43EF-8E1B-9462847AE13E-en-US-9/GUID-87B07C9C-6305-4E40-9BD9-F9418D80761A.html">6.5.5
Path, File and Folder Name Restrictions</a>.</li>
<li>The TrustZone based project come with long path name, hence the
project build may fail due to exceeding Windows maximum path
length.</li>
<li><strong>Workaround:</strong> Move the project folder to C:/ drive to
reduce the project path length then open in MPLAB X IDE to build the
project.</li>
</ul></li>
</ul>
<h2 id="running-the-demo">Running the Demo:
<span id="RunningDemo"><span></h2>
<ul>
<li><strong>Basic functionality</strong> <span id="BasicDemo"><span>
<ul>
<li>Perform <a href="#Setup1">Hardware Setup 1</a> steps mentioned
above, if not done already.</li>
<li>Open the Tera Term terminal application on your PC (from the
Windows® Start menu by pressing the Start button).</li>
<li>Set the baud rate to 115200.</li>
<li>Reset or power cycle the device. LED0 toggles for every 500
milliseconds during power cycle.</li>
<li>An LED (LED0) on the PIC32CK SG01 Curiosity Ultra Development Board
toggles on every timeout basis and the default periodicity of the
timeout is 500 milliseconds.</li>
<li>And also, the LED toggling rate is displayed on the serial
terminal.</li>
<li>Press the switch SW0 on the PIC32CK SG01 Curiosity Ultra Development
Board to change the periodicity of the timeout to one second.</li>
<li>Every subsequent pressing of the switch SW0 on the PIC32CK SG01
Curiosity Ultra Development Board changes the periodicity of the timeout
to 2 seconds, 4 seconds, 500 milliseconds, and back to 1 second in
cyclic order.</li>
<li>See the following figure for the output.<br />
<img src = "images/result_01.png"></li>
</ul></li>
<li><strong>Extended functionality using <a
href="https://www.microchip.com/Developmenttools/ProductDetails/ATIO1-XPRO">I/O1
Xplained Pro Extension Kit</a>:</strong> <span id="ExtendedDemo"><span>
<ul>
<li><p>Perform <a href="#Setup2">Hardware Setup 2</a> steps mentioned
above, if not done already.</p></li>
<li><p>Open the Tera Term terminal application on your PC (from the
Windows® Start menu by pressing the Start button)</p></li>
<li><p>Change the baud rate to 115200</p></li>
<li><p>Press <strong>SW1</strong> to start the running the extended
functionality.</p></li>
<li><p>You should see the temperature values (in °F) being displayed on
the terminal every 500 milliseconds, as shown below<br />
<img src = "images/result1.png"></p></li>
<li><p>Also, notice the LED0 blinking at 500 millisecond rate</p></li>
<li><p>You may vary the temperature by placing your finger on the
temperature sensor (for a few seconds)<br />
<img src = "images/temp_sensor_placement.jpg"></p></li>
<li><p>Press the switch <strong>SW0</strong> on PIC32CK SG01 Curiosity
Ultra Development Board to change the default sampling rate to 1
second.<br />
<img src = "images/user_button_placement.jpg"><br />
<img src = "images/result2.png"></p></li>
<li><p>Every subsequent pressing of switch <strong>SW0</strong> on
PIC32CK SG01 Curiosity Ultra Development Board changes the default
sampling rate to 2 seconds, 4 seconds, and 500 ms and back to 1 second
in cyclic order as shown below.<br />
<img src = "images/result3.png"></p></li>
<li><p>While the temperature sampling rate changes on every switch
<strong>SW0</strong> press, notice the LED0 toggling at the same
sampling rate</p></li>
<li><p>Press any character on the terminal to display the last five
values written to the EEPROM. Notice that a red LED (LED1) will be
toggled when a key is pressed in the serial console to read the
temperature values from the <strong>secure EEPROM</strong>.<br />
<img src = "images/eeprom_values_display.png"></p></li>
<li><p>Anytime press <strong>SW1</strong> to start running basic
functionality shown in <a href="#BasicDemo">Basic
functionality</a></p></li>
</ul></li>
</ul>
<h2 id="comments">Comments: <span id="Comments"><span></h2>
<ul>
<li><a
href="https://ww1.microchip.com/downloads/en/DeviceDoc/Dual-Developer-Application-Development-Use-Case-with-TrustZone-on-SAM-L11-Using-MPLAB-Harmony-DS90003306.pdf">Dual
Developer Application Development Use Case with TrustZone on SAM L11
Using MPLAB Harmony v3</a>
<ul>
<li><strong>Note:</strong> Though this technical brief is on SAM L11
MCUs, the TrustZone concepts it describes also applies to PIC32CM MC
LS00 MCUs.</li>
</ul></li>
<li>This application demo builds and works out of box by following the
instructions above in “Running the Demo” section. If you need to
enhance/customize this application demo, you need to use the MPLAB
Harmony v3 Software framework. Refer links below to setup and build your
applications using MPLAB Harmony.
<ul>
<li><a
href="https://ww1.microchip.com/downloads/en/DeviceDoc/How_to_Setup_MPLAB_%20Harmony_v3_Software_Development_Framework_DS90003232C.pdf">How
to Setup MPLAB Harmony v3 Software Development Framework</a></li>
<li><a
href="http://ww1.microchip.com/downloads/en/DeviceDoc/How_to_Build_Application_Adding_PLIB_%20Driver_or_Middleware%20_to_MPLAB_Harmony_v3Project_DS90003253A.pdf">How
to Build an Application by Adding a New PLIB, Driver, or Middleware to
an Existing MPLAB Harmony v3 Project</a><br />
</li>
<li><span style="color:blue"> <strong>MPLAB Harmony v3 is also
configurable through MPLAB Code Configurator (MCC). Refer to the below
links for specific instructions to use MPLAB Harmony v3 with
MCC.</strong></span>
<ul>
<li><a
href="https://microchipdeveloper.com/harmony3:getting-started-training-module-using-mcc">Create
a new MPLAB Harmony v3 project using MCC</a></li>
<li><a
href="https://microchipdeveloper.com/harmony3:update-and-configure-existing-mhc-proj-to-mcc-proj">Update
and Configure an Existing MHC-based MPLAB Harmony v3 Project to
MCC-based Project</a></li>
<li><a href="https://www.youtube.com/watch?v=KdhltTWaDp0">Getting
Started with MPLAB Harmony v3 Using MPLAB Code Configurator</a></li>
<li><a href="https://www.youtube.com/watch?v=PRewTzrI3iE">MPLAB Code
Configurator Content Manager for MPLAB Harmony v3 Projects</a></li>
</ul></li>
</ul></li>
</ul>
<h2 id="revision">Revision:</h2>
<ul>
<li>v1.7.0 - Released demo application</li>
</ul>
